[build-system]
requires = [
    "setuptools",
    "setuptools-protobuf[mypy]>=0.1.3",
    "setuptools-rust>=1.7.0",
]
build-backend = "setuptools.build_meta"

[tool.mypy]
warn_redundant_casts = true
warn_unused_configs = true
check_untyped_defs = true

[[tool.mypy.overrides]]
module = [
    # No type hints yet
    "gpg.*",
    "aioredlock.*",
    "diffoscope.*",
    "ruamel.*",
    "aiohttp_apispec.*",
    "launchpadlib.*",
    "mimeparse.*",
    "google.cloud.logging.*",
    "klaus.*",
    "aiohttp_debugtoolbar.*",
    "fakeredis.*",
    "aiohttp_wsgi.*",
    # https://github.com/MagicStack/asyncpg/issues/387
    "asyncpg.*",
    "testing.*",
    "boto3.*",
    "google.protobuf.*",
    "pytest_asyncio.*",
    "silver_platter.*",
]
ignore_missing_imports = true

[project]
name = "janitor"
authors = [{name = "Jelmer VernooÄ³", email = "jelmer@jelmer.uk"}]
description = "Manager for automatic VCS changes"
license = {text = "GNU GPL v2 or later"}
keywords = [
    "debian",
    "git",
    "bzr",
    "vcs",
    "github",
    "gitlab",
    "launchpad",
]
classifiers = [
    "Development Status :: 3 - Alpha",
    "License :: OSI Approved :: GNU General Public License (GPL)",
    "Programming Language :: Python :: 3.9",
    "Programming Language :: Python :: 3.10",
    "Programming Language :: Python :: 3.11",
    "Programming Language :: Python :: 3.12",
    "Programming Language :: Python :: 3.13",
    "Programming Language :: Python :: Implementation :: CPython",
    "Programming Language :: Python :: Implementation :: PyPy",
    "Operating System :: POSIX",
    "Topic :: Software Development :: Version Control",
]
urls = {Homepage = "https://github.com/jelmer/janitor"}
requires-python = ">=3.9"
dependencies = [
    "aiohttp",
    "aiohttp-apispec",
    "aiohttp-openmetrics",
    "aiohttp-jinja2",
    "aiojobs",
    "aioredlock",
    "aiozipkin",
    "asyncpg",
    "backoff",
    "breezy[git,launchpad,workspace,pgp]",
    "bs4",
    "dulwich",
    "iso8601",
    "jinja2",
    "paramiko",
    "protobuf",
    "pygments",
    "python-mimeparse",
    "redis>=4.2.0",
    "silver-platter",
    "uvloop",
]
dynamic = ["version"]

[project.readme]
file = "README.md"
content-type = "text/markdown"

[project.optional-dependencies]
# Janitor service (./Dockerfile_archive)
archive = [
    "python-debian",
]
# Janitor service (./Dockerfile_bzr_store)
bzr_store = [
    "loggerhead",
    "python-debian",
]
# Janitor service (./Dockerfile_differ)
differ = [
    "python-debian",
]
# Janitor service (./Dockerfile_git_store)
git_store = [
    "aiohttp-wsgi",
    "klaus@git+https://github.com/jonashaag/klaus",
    "python-debian",
]
# Janitor service (./Dockerfile_publish)
publish = []
# Janitor service (./Dockerfile_runner)
runner = [
    "python-debian",
]
# Janitor service (./Dockerfile_site)
site = [
    "python-debian",
]

# Development (./CONTRIBUTING.md)
dev = [
    "boto3",
    "djlint",
    "fakeredis",
    "gcloud-aio-storage",
    "google-cloud-logging",
    "mock",
    "mypy",
    "pytest",
    "pytest-aiohttp",
    "pytest-cov",
    "python-debian",
    "python-subunit",
    "ruff==0.9.6",
    "setuptools-protobuf",
    "setuptools-rust",
    "testing.postgresql",
    "testtools",
    "types-beautifulsoup4",
    "types-boto3",
    "types-flask",
    "types-mock",
    "types-protobuf",
    "types-Pygments",
    "types-PyYAML",
    "types-redis",
    "yamllint",
]

# unittest ($ make test)
test = [
    "fakeredis",
    "pytest",
    "pytest-aiohttp",
    "pytest-asyncio",
    "pytest-cov",
    "python-debian",
    "setuptools-protobuf",
    "setuptools-rust",
    "testing.postgresql",
    "testtools",
]

debian = [
    "brz-debian@git+https://github.com/breezy-team/breezy-debian",
    "iniparse",
    "ognibuild[debian,dep_server]",
    "python-debian",
    "silver-platter[debian]",
]

# Google Cloud Platform
gcp = [
    "gcloud-aio-storage",
    "google-cloud-logging",
]

s3 = [
    "boto3",
]

[project.scripts]
janitor-runner = "janitor.run:main"
janitor-publisher = "janitor.publish:main"
janitor-apt = "janitor.debian.archive:main"
janitor-git-store = "janitor.git_store:main"
janitor-bzr-store = "janitor.git_store:main"
janitor-differ = "janitor.differ:main"

[tool.pytest.ini_options]
asyncio_mode = "auto"
addopts = """
--cov=janitor
--cov-report=html"""

[tool.setuptools]
script-files = [
    "create-sbuild-chroot-schroot.py",
    "create-sbuild-chroot-unshare.py",
]
include-package-data = false

[tool.setuptools.packages.find]
where = ["py"]
include = ["janitor*"]

[tool.setuptools.package-data]
"*" = ["py.typed"]
"janitor.site" = [
    "templates/*.html",
    "templates/*/*.html",
    "_static/*.css",
    "_static/*.js",
    "_static/*.png",
]
janitor = ["state.sql"]
"janitor.debian" = ["debian.sql"]

[tool.setuptools.dynamic]
version = {attr = "janitor.__version__"}

[tool.ruff.lint]
select = [
    "ANN",
    "B",
    "W",
    "D",
    "E",
    "F",
    "I",
    "B",
    "UP",
]
ignore = [
    "ANN001",
    "ANN002",
    "ANN003",
    "ANN201",
    "ANN202",
    "ANN204",
    "ANN206",
    "ANN401",
    "E501",
    "W293",
    "W291",
    "B905",
    "D100",
    "D101",
    "D102",
    "D103",
    "D104",
    "D105",
    "D107",
    "D417",
    "B007"
]

[tool.ruff]
line-length = 88
target-version = "py39"
extend-exclude = ["py/janitor/config_pb2.py", "py/janitor/config_pb2.pyi"]

[tool.ruff.lint.pydocstyle]
convention = "google"

[tool.codespell]
skip = "./target,./build,./lib,*~"
ignore-words = ".codespell-ignore-words"

[tool.ruff.lint.flake8-tidy-imports.banned-api]
"lintian_brush".msg = "belongs in Debian Janitor"
"debmutate".msg = "not used directly"
"upstream_ontologist".msg = "not used"

[tool.setuptools-protobuf]
mypy = true
protobufs = [
    "py/janitor/config.proto"
]

[tool.ruff.lint.isort]
known-third-party = ["debian"]
